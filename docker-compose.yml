# ============================================================================
# MICROSERVICES PLATFORM - Docker Compose
# ============================================================================
#
# Architecture:
#   - E-commerce: 5 services (user, product, transaction, wallet, notify)
#   - Chat System: 3 services (core, fanout, socket-gateway)
#   - Frontend: React + Vite
#   - Infrastructure: MySQL, MongoDB, Redis, Kafka, Elasticsearch
#
# Quick Start:
#   docker-compose up -d                # Start all services
#   docker-compose up -d mysql redis    # Start infrastructure only
#   docker-compose logs -f <service>    # View logs
#   docker-compose down                 # Stop all
#   docker-compose down -v              # Stop and remove volumes
#
# Services Ports:
#   Frontend:        http://localhost:3000
#   User Service:    http://localhost:8081
#   Product:         http://localhost:8082
#   Transaction:     http://localhost:8083
#   Wallet:          http://localhost:8084
#   Notify:          http://localhost:8085
#   Chat Core:       http://localhost:8091 (gRPC: 9090)
#   Chat Fanout:     http://localhost:8092
#   Chat Socket:     http://localhost:8093
#
# ============================================================================

version: '3.8'

services:
  # ==================
  # INFRASTRUCTURE
  # ==================

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ecommerce_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - microservices-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7.0
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-rootpassword}
      MONGO_INITDB_DATABASE: product_db
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - microservices-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis-cache
    command: redis-server ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - microservices-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: bitnami/kafka:4.0
    container_name: kafka-broker
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://${KAFKA_HOST:-kafka}:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - microservices-net
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - microservices-net
    restart: unless-stopped

  # ==================
  # E-COMMERCE SERVICES
  # ==================

  ecommerce-user:
    build: ./services/ecommerce-sys/user
    container_name: ecommerce-user-service
    ports:
      - "${USER_SERVICE_PORT:-8081}:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:3306/${USER_DB_NAME:-user_db}?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${USER_DB_USERNAME:-root}
      SPRING_DATASOURCE_PASSWORD: ${USER_DB_PASSWORD:-rootpassword}
      SPRING_DATA_MONGODB_URI: mongodb://${MONGODB_ROOT_USERNAME:-root}:${MONGODB_ROOT_PASSWORD:-rootpassword}@${MONGODB_HOST:-mongodb}:27017/${USER_MONGODB_DB:-logdb}?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${USER_KAFKA_GROUP_ID:-user-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      FILE_UPLOAD_DIR: ${USER_FILE_UPLOAD_DIR:-uploads}
      FILE_BASE_URL: ${USER_FILE_BASE_URL:-http://localhost:8081/files}
      SECURITY_SECRET_TOKENS_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET}
      SECURITY_SECRET_TOKENS_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600000}
      SECURITY_SECRET_TOKENS_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET}
      SECURITY_SECRET_TOKENS_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-604800000}
      SECURITY_SECRET_AES_KEY: ${AES_KEY}
      SECURITY_SECRET_AES_IV: ${AES_IV}
    volumes:
      - user_uploads:/app/uploads
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - microservices-net
    restart: unless-stopped

  ecommerce-product:
    build: ./services/ecommerce-sys/product
    container_name: ecommerce-product-service
    ports:
      - "${PRODUCT_SERVICE_PORT:-8082}:8080"
    environment:
      SPRING_DATA_MONGODB_URI: mongodb://${MONGODB_ROOT_USERNAME:-root}:${MONGODB_ROOT_PASSWORD:-rootpassword}@${MONGODB_HOST:-mongodb}:27017/${PRODUCT_MONGODB_DB:-product}?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${PRODUCT_KAFKA_GROUP_ID:-product-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      ELASTICSEARCH_URIS: http://${ELASTICSEARCH_HOST:-elasticsearch}:9200
      FILE_UPLOAD_DIR: ${PRODUCT_FILE_UPLOAD_DIR:-uploads}
      FILE_BASE_URL: ${PRODUCT_FILE_BASE_URL:-http://localhost:8082/files}
      SEARCH_CACHE_TTL: ${PRODUCT_SEARCH_CACHE_TTL:-300}
      SEARCH_MAX_PAGE_SIZE: ${PRODUCT_SEARCH_MAX_PAGE_SIZE:-100}
      SEARCH_DEFAULT_PAGE_SIZE: ${PRODUCT_SEARCH_DEFAULT_PAGE_SIZE:-20}
    volumes:
      - product_uploads:/app/uploads
    depends_on:
      - mongodb
      - redis
      - kafka
      - elasticsearch
    networks:
      - microservices-net
    restart: unless-stopped

  ecommerce-transaction:
    build: ./services/ecommerce-sys/transaction
    container_name: ecommerce-transaction-service
    ports:
      - "${TRANSACTION_SERVICE_PORT:-8083}:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:3306/${TRANSACTION_DB_NAME:-transaction_db}?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${TRANSACTION_DB_USERNAME:-root}
      SPRING_DATASOURCE_PASSWORD: ${TRANSACTION_DB_PASSWORD:-rootpassword}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${TRANSACTION_KAFKA_GROUP_ID:-transaction-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      FILE_UPLOAD_DIR: ${TRANSACTION_FILE_UPLOAD_DIR:-uploads}
      FILE_BASE_URL: ${TRANSACTION_FILE_BASE_URL:-http://localhost:8083/files}
    volumes:
      - transaction_uploads:/app/uploads
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - microservices-net
    restart: unless-stopped

  ecommerce-wallet:
    build: ./services/ecommerce-sys/wallet
    container_name: ecommerce-wallet-service
    ports:
      - "${WALLET_SERVICE_PORT:-8084}:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:3306/${WALLET_DB_NAME:-wallet_db}?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${WALLET_DB_USERNAME:-root}
      SPRING_DATASOURCE_PASSWORD: ${WALLET_DB_PASSWORD:-rootpassword}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${WALLET_KAFKA_GROUP_ID:-wallet-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - microservices-net
    restart: unless-stopped

  ecommerce-notify:
    build: ./services/ecommerce-sys/notify
    container_name: ecommerce-notify-service
    ports:
      - "${NOTIFY_SERVICE_PORT:-8085}:8080"
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${NOTIFY_KAFKA_GROUP_ID:-notify-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_MAIL_HOST: ${NOTIFY_MAIL_HOST:-smtp.gmail.com}
      SPRING_MAIL_PORT: ${NOTIFY_MAIL_PORT:-587}
      SPRING_MAIL_USERNAME: ${NOTIFY_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${NOTIFY_MAIL_PASSWORD}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: ${NOTIFY_MAIL_SMTP_AUTH:-true}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: ${NOTIFY_MAIL_SMTP_STARTTLS:-true}
    depends_on:
      - redis
      - kafka
    networks:
      - microservices-net
    restart: unless-stopped

  # ==================
  # CHAT SERVICES
  # ==================

  chat-core:
    build: ./services/Chat-system/core-services
    container_name: chat-core-services
    ports:
      - "${CHAT_CORE_SERVICE_PORT:-8091}:8080"
      - "${CHAT_CORE_GRPC_PORT:-9090}:9090"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:3306/${CHAT_DB_NAME:-slack_clone}?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${CHAT_DB_USERNAME:-root}
      SPRING_DATASOURCE_PASSWORD: ${CHAT_DB_PASSWORD:-rootpassword}
      SPRING_DATA_MONGODB_URI: mongodb://${MONGODB_ROOT_USERNAME:-root}:${MONGODB_ROOT_PASSWORD:-rootpassword}@${MONGODB_HOST:-mongodb}:27017/${CHAT_MONGODB_DB:-logdb}?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${CHAT_KAFKA_GROUP_ID:-chat-core-service}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      OUTBOX_FALLBACK_BATCH_SIZE: ${CHAT_OUTBOX_BATCH_SIZE:-100}
      OUTBOX_FALLBACK_MAX_CONCURRENT: ${CHAT_OUTBOX_MAX_CONCURRENT:-10}
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - microservices-net
    restart: unless-stopped

  chat-fanout:
    build: ./services/Chat-system/fanout_worker
    container_name: chat-fanout-worker
    ports:
      - "${CHAT_FANOUT_SERVICE_PORT:-8092}:8080"
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: ${CHAT_FANOUT_KAFKA_GROUP_ID:-chat-fanout-worker}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      GRPC_CLIENT_CORE_SERVICES_ADDRESS: static://${CHAT_FANOUT_GRPC_SERVER:-chat-core:9090}
    depends_on:
      - redis
      - kafka
      - chat-core
    networks:
      - microservices-net
    restart: unless-stopped

  chat-socket:
    build: ./services/Chat-system/socket_gateway
    container_name: chat-socket-gateway
    ports:
      - "${CHAT_SOCKET_SERVICE_PORT:-8093}:8080"
    environment:
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      GRPC_CLIENT_CORE_SERVICES_ADDRESS: static://${CHAT_SOCKET_GRPC_SERVER:-chat-core:9090}
    depends_on:
      - redis
      - chat-core
    networks:
      - microservices-net
    restart: unless-stopped

  # ==================
  # FRONTEND
  # ==================

  frontend:
    build:
      context: ./frontends/ecommerce-sys-fe/my-app
      args:
        VITE_AUTH_API_URL: ${VITE_API_URL:-http://localhost:8081}
        VITE_PRODUCT_API_URL: ${VITE_PRODUCT_API_URL:-http://localhost:8082}
        VITE_TRANSACTION_API_URL: ${VITE_TRANSACTION_API_URL:-http://localhost:8083}
        VITE_WALLET_API_URL: ${VITE_WALLET_API_URL:-http://localhost:8084}
        VITE_NOTIFY_WS_URL: ${VITE_NOTIFY_WS_URL:-ws://localhost:8085}
        VITE_CHAT_API_URL: ${VITE_CHAT_API_URL:-http://localhost:8091}
        VITE_CHAT_WS_URL: ${VITE_CHAT_WS_URL:-ws://localhost:8093}
    container_name: ecommerce-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - ecommerce-user
      - ecommerce-product
      - ecommerce-transaction
      - ecommerce-wallet
      - ecommerce-notify
    networks:
      - microservices-net
    restart: unless-stopped

networks:
  microservices-net:
    driver: bridge

volumes:
  mysql_data:
  mongodb_data:
  redis_data:
  kafka_data:
  elasticsearch_data:
  user_uploads:
  product_uploads:
  transaction_uploads:
